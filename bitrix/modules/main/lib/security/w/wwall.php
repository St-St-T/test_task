<? namespace Bitrix\Main\Security\W;$GLOBALS['____1113378835']= array(base64_decode('d'.'GltZQ=='),base64_decode('dG'.'ltZQ'.'=='),base64_decode('anNvbl'.'9kZWNvZGU='),base64_decode('Y'.'X'.'JyYXlfbWVy'.'Z2U'.'='),base64_decode(''.'am9pbg=='),base64_decode('am9pbg=='),base64_decode('am9p'.'bg=='),base64_decode('YXJyYX'.'l'.'fc'.'G9w'),base64_decode('YXJyYXlfc2hpZn'.'Q='),base64_decode(''.'YXJyY'.'Xlfc2hpZnQ'.'='),base64_decode('YXJyY'.'Xlf'.'c2h'.'pZnQ='),base64_decode('Y'.'XJy'.'YXlfc2hp'.'Z'.'n'.'Q='),base64_decode('YXJ'.'yYX'.'lfbW'.'VyZ2U='),base64_decode(''.'aXNf'.'Y'.'XJyYXk='),base64_decode(''.'YX'.'Jy'.'Y'.'Xl'.'fbWV'.'yZ'.'2U'.'='),base64_decode('a'.'W5'.'fYXJyYXk='),base64_decode(''.'aW5fYXJ'.'yYXk'.'='),base64_decode('aW5fYXJyYXk='),base64_decode('aW5fYXJyYXk='),base64_decode('aW5fYXJ'.'yYXk='),base64_decode('dGl'.'tZQ'.'='.'='),base64_decode('dGlt'.'ZQ=='),base64_decode('Y'.'XJyYXlfbWFw'),base64_decode('Z2V0'.'X2xvYWR'.'l'.'Z'.'F9leHRlbn'.'N'.'pb25z'),base64_decode('a'.'nNvbl9lbmNvZG'.'U='),base64_decode('a'.'nNvb'.'l'.'9l'.'b'.'mNvZ'.'G'.'U='),base64_decode('cGhwdmVyc2lvbg=='),base64_decode('anNv'.'bl9'.'lbmNvZGU='),base64_decode('a'.'m9pbg=='));if(!function_exists(__NAMESPACE__.'\\___893756838')){function ___893756838($_1301351859){static $_888872577= false; if($_888872577 == false) $_888872577=array('V1d'.'BTExf'.'T'.'E9DSw==','c2Vj'.'dXJpdHk'.'=','REF'.'UQQ==','eyI=','V1dBTExfTE9D'.'Sw==','c2VjdX'.'JpdHk=','U0'.'VD'.'V'.'V'.'JJVFlfV'.'1d'.'BTExfR'.'Vh'.'DRVBUSU9O','RkF'.'JTF9D'.'S'.'E'.'VDS0lORw='.'=','Q'.'2FuIG5vdCBl'.'eGVj'.'dXRlI'.'Hd'.'3YWxsIHJ1'.'b'.'G'.'V'.'zOiA=','IFR'.'yY'.'WNlOi'.'A=','Uk'.'VRVU'.'VT'.'VF'.'9'.'VUkk=','a2V'.'5'.'cw==','dmFsdWVz','U0'.'V'.'DVV'.'JJVFl'.'fV1dBTE'.'xf'.'TU'.'9ESUZZ','Lg==','U0VDVVJJVFl'.'fV'.'1dBTExfV'.'U5'.'TR'.'VQ=',''.'Lg==','U0V'.'DV'.'VJJVF'.'l'.'fV1dB'.'T'.'E'.'xfRVhJVA==','Lg==','Z2'.'xvYmFs','a2V5cw='.'=','dmF'.'s'.'dWVz','Z2V0',''.'Z2V0','cG9zdA==','cG9'.'zd'.'A==',''.'Y29'.'va2ll','Y29va2ll','cmVxd'.'WVzdA='.'=','cmV'.'xdWV'.'zdA==',''.'Z2xvYmF'.'s',''.'Z2xvYmFs','bW'.'Fpbl9zZWM=','V1'.'d'.'BTExf'.'Q'.'U'.'N'.'UVUF'.'MSVp'.'FX1JVT'.'EVT','dg==','dmV'.'y'.'c2lvbg==','aQ'.'==','aXNJbnN0'.'Y'.'WxsZWQ=','dg==','aW5'.'p','bW9kdWx'.'lcw==','b'.'GljZW5zZQ==',''.'c'.'Ghw','dg==','ZXh0','c2VjdXJpdHk=',''.'Z'.'GI=',''.'dHlwZQ==','ZGI=',''.'dmV'.'yc2l'.'vbg'.'==','ZGI=','dHlw'.'Z'.'Q'.'==','ZGI=','dHlw'.'Z'.'Q==','dmVy'.'c2lvbg='.'=','Z'.'GI=','d'.'mVy'.'c2lvbg==',''.'ZW52aXJ'.'vbm1lbnQ=','dm'.'1f'.'dmV'.'yc2lvbg==','dm0=','dg==','ZW52'.'aXJvb'.'m1lbnQ=',''.'dm1'.'fd'.'mVyc2'.'lv'.'bg'.'='.'=','c2'.'9ja2V0VGl'.'tZ'.'W9'.'1d'.'A='.'=','c3RyZ'.'WF'.'tVGltZW91'.'dA==','KCc=','Z'.'GF0'.'YQ='.'=','JywgJ'.'w==','bW9kdWxl','JywgJ'.'w==','bW9kdWxl'.'X3ZlcnN'.'pb24=','Jyk=','LCA=',''.'U0'.'VDVV'.'JJVFl'.'fV1dBTE'.'xfRVhD'.'R'.'VBU'.'S'.'U9O','bWFpbg==','RkFJTF9SRUZSRV'.'NI'.'SU5H','Q2Fu'.'IG5vdC'.'ByZWZyZXNoI'.'H'.'d3YWxsIHJ1'.'bGV'.'zOiA=','I'.'FRy'.'YWNlOiA'.'=','ZGF'.'0Y'.'Q==','e'.'y'.'I'.'=',''.'LS0t'.'LS'.'1CR'.'UdJTiBQVUJMSUMgS0VZ'.'LS0tLS0=','Ck1JSUJJakFOQm'.'d'.'rcWhraU'.'c5dzBCQV'.'F'.'F'.'RkFB'.'T0NB'.'UTh'.'BTUl'.'JQk'.'Nn'.'S0'.'NBUU'.'VBcT'.'hR'.'R'.'TBIam1'.'I'.'Sl'.'VTd'.'Fd'.'W'.'Nm4'.'wem'.'EK'.'UlZvTH'.'gw'.'Mk'.'t6YmZyYlMvUD'.'ZzV2'.'F4VH'.'p3OF'.'NlR1R0Yl'.'R'.'D'.'T3JwSGk'.'1UUY2T1'.'J5alo'.'v'.'W'.'H'.'h6L0'.'t'.'MVTFHYm9mOUNaMw'.'o0e'.'jdTa3FVdD'.'Y'.'2a'.'WJYdk'.'9GQn'.'g0Zncv'.'QV'.'BQ'.'Uk'.'dEcXRt'.'M'.'G5EM2'.'Zn'.'R3N1M1Jl'.'UGd'.'3MjlpO'.'Ct2bTdtdEJ'.'LSlVZbDRyC'.'lZwY'.'jZzZlpF'.'VD'.'lLRWI'.'2VDFIR'.'FltRXZjMW'.'hxL2l'.'p'.'dX'.'l4'.'TH'.'JaW'.'mk1UTZVZmY0VUV2V'.'EkrNjh'.'zc'.'0ZSa1Erb'.'3dUUnkK'.'ZU9JTWJ'.'GaE0vVVRtZl'.'ZZYlRS'.'Rn'.'k'.'yb'.'1V'.'ROFdNemEy'.'b'.'ko1U2Fo'.'emk'.'xVUtP'.'MWpBalhUU'.'FJyemM3Q'.'W'.'p'.'1NjM5ajFPMA'.'pw'.'cHFmbTV4Z1dsR'.'kFKa0hRV'.'Gdi'.'Z'.'G'.'Q'.'1'.'Q'.'Vdx'.'REZRa3'.'Q'.'5'.'SEtrWStUbmZCTEdWTXZWeVB3V'.'EhO'.'V'.'1F'.'ZQXc0e'.'HB'.'nL3dBClp'.'3SUR'.'BUUFCC'.'i0tLS0tRU'.'5'.'EIFBV'.'Qk'.'xJQyBLRV'.'kt'.'L'.'S0t'.'LQ==');return base64_decode($_888872577[$_1301351859]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1317852618= 'https://wwall.bitrix.info/rules.php'; protected $_1861785850= true; public function handle(){ try{  $_1145867110= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1145867110)){ return;}  $_1007693668= Cache::createInstance(); $_238332018= false; if($_1007693668->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1718868336= $_1007693668->getVars(); if($GLOBALS['____1113378835'][0]()- $_1718868336> round(0+20)){  $_1974467194= Application::getConnection(); $_1448923200= RuleRecordTable::getTableName(); $_1974467194->truncateTable($_1448923200); RuleRecordTable::cleanCache(); $_1007693668->clean(___893756838(0), ___893756838(1));}} elseif($_1007693668->startDataCache()){  $_1007693668->endDataCache($GLOBALS['____1113378835'][1]()); $_238332018= true;} foreach($_1145867110 as $_1843523722){ $_413363719= new PublicKeyCipher; $_1112940038= $_413363719->decrypt($_1843523722[___893756838(2)], static::__2000683850()); if(!str_starts_with($_1112940038, ___893756838(3))){ continue;} $_719215836= $GLOBALS['____1113378835'][2]($_1112940038, true); if(!empty($_719215836)){ $_2042899483= Rule::make($_719215836); $_2142294388= $this->handleRule($_2042899483); $this->applyHandlingResults($_2142294388);}}  if($_238332018){ $_1007693668->clean(___893756838(4), ___893756838(5));}} catch(\Throwable $_985897926){ $this->logEvent( ___893756838(6), ___893756838(7), ___893756838(8). $_985897926->getMessage(). ___893756838(9). $_985897926->getTraceAsString());}}  public function handleRule(Rule $_2042899483): array{ $_2142294388=[]; if($_2042899483->matchPath($_SERVER[___893756838(10)])){  $_1850277322= $this->getContextElements($_2042899483->getContext()); foreach($_1850277322 as $_1811926612 => &$_273868569){ $_2142294388= $GLOBALS['____1113378835'][3]($_2142294388, $this->recursiveContextKeyHandle($_1811926612, $_273868569,[], $_2042899483));}} return $_2142294388;}  public function applyHandlingResults(array $_2142294388){ $_1850277322= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_2142294388 as $_149137661){ $_273868569=& $_1850277322[$_149137661->getContextName()]; $_87675186= $_149137661->getRuleResult(); $_2042899483= $_149137661->getRule(); if($_87675186 instanceof ModifyResult){ if($_2042899483->getProcess() === ___893756838(11)){  static::rewriteContextKey( $_149137661->getContextName(), $_273868569, $_149137661->getContextKey(), $_87675186->getCleanValue());} elseif($_2042899483->getProcess() === ___893756838(12)){ static::rewriteContextValue( $_149137661->getContextName(), $_273868569, $_149137661->getContextKey(), $_87675186->getCleanValue());} $this->logEvent( ___893756838(13), $_149137661->getContextName(), $GLOBALS['____1113378835'][4](___893756838(14), $_149137661->getContextKey()));} elseif($_87675186 instanceof CheckResult &&!$_87675186->isSuccess()){ if($_87675186->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_149137661->getContextName(), $_273868569, $_149137661->getContextKey(),); $this->logEvent( ___893756838(15), $_149137661->getContextName(), $GLOBALS['____1113378835'][5](___893756838(16), $_149137661->getContextKey()));} elseif($_87675186->getAction() === RuleAction::EXIT){ $this->logEvent( ___893756838(17), $_149137661->getContextName(), $GLOBALS['____1113378835'][6](___893756838(18), $_149137661->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1861785850= false;} protected function rewriteContextKey($_1811926612, &$_273868569, $_851746136, $_330106067){ $_547925996= $_851746136;  $GLOBALS['____1113378835'][7]($_547925996); $_547925996[]= $_330106067; if($_1811926612 === ___893756838(19)){ $_1490740376= $GLOBALS['____1113378835'][8]($_851746136); $GLOBALS['____1113378835'][9]($_547925996); if(empty($_851746136)){ $GLOBALS[$_330106067]= $GLOBALS[$_1490740376]; unset($GLOBALS[$_1490740376]);} else{ $_273868569=& $GLOBALS[$_1490740376]; $_100389547= ArrayHelper::getByNestedKey($_273868569, $_851746136);  ArrayHelper::setByNestedKey($_273868569, $_547925996, $_100389547);  ArrayHelper::unsetByNestedKey($_273868569, $_851746136);}} else{ $_100389547= ArrayHelper::getByNestedKey($_273868569, $_851746136);  ArrayHelper::setByNestedKey($_273868569, $_547925996, $_100389547);  ArrayHelper::unsetByNestedKey($_273868569, $_851746136);}} protected function rewriteContextValue($_1811926612, &$_273868569, $_788950938, $_100389547){ if($_1811926612 === 'global'){ $_1490740376= $GLOBALS['____1113378835'][10]($_788950938); if(empty($_788950938)){ $GLOBALS[$_1490740376]= $_100389547;} else{ $_273868569=& $GLOBALS[$_1490740376]; ArrayHelper::setByNestedKey($_273868569, $_788950938, $_100389547);}} else{  ArrayHelper::setByNestedKey($_273868569, $_788950938, $_100389547);}} protected function unsetContextValue($_1811926612, &$_273868569, $_788950938){ if($_1811926612 === 'global'){ $_1490740376= $GLOBALS['____1113378835'][11]($_788950938); if(empty($_788950938)){ unset($GLOBALS[$_1490740376]);} else{ $_273868569=& $GLOBALS[$_1490740376]; ArrayHelper::unsetByNestedKey($_273868569, $_788950938);}} else{ ArrayHelper::unsetByNestedKey($_273868569, $_788950938);}}  protected function recursiveContextKeyHandle(string $_1811926612, array &$_273868569, array $_556551838, Rule $_2042899483): array{  $_2142294388=[]; foreach($_273868569 as $_799263880 => $_100389547){ $_788950938= $GLOBALS['____1113378835'][12]($_556551838,[$_799263880]); if($_2042899483->matchKey($_788950938)){  if($_2042899483->getProcess() === ___893756838(20)){ $_87675186= $_2042899483->evaluate($_799263880);} elseif($_2042899483->getProcess() === ___893756838(21)){ $_87675186= $_2042899483->evaluateValue($_100389547);}  if(!empty($_87675186) && $_87675186 instanceof RuleResult){ $_2142294388[]= new HandlingResult($_1811926612, $_788950938, $_87675186, $_2042899483);}}  if($GLOBALS['____1113378835'][13]($_100389547)){ $_2142294388= $GLOBALS['____1113378835'][14]($_2142294388, $this->recursiveContextKeyHandle( $_1811926612, $_273868569[$_799263880], $_788950938, $_2042899483));}} return $_2142294388;} protected function getContextElements(array $_1007980915){ $_1513536746=[]; if($GLOBALS['____1113378835'][15](___893756838(22), $_1007980915, true)){ $_1513536746[___893756838(23)]= &$_GET;} if($GLOBALS['____1113378835'][16](___893756838(24), $_1007980915, true)){ $_1513536746[___893756838(25)]= &$_POST;} if($GLOBALS['____1113378835'][17](___893756838(26), $_1007980915, true)){ $_1513536746[___893756838(27)]= &$_COOKIE;} if($GLOBALS['____1113378835'][18](___893756838(28), $_1007980915, true)){ $_1513536746[___893756838(29)]= &$_REQUEST;} if($GLOBALS['____1113378835'][19](___893756838(30), $_1007980915, true)){ $_1513536746[___893756838(31)]= $GLOBALS;} return $_1513536746;} public static function refreshRules(){ try{ $_1691993382= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1113378835'][20]()- $_1691993382)< static::CACHE_RULES_TTL){ return;} Option::set(___893756838(32), ___893756838(33), $GLOBALS['____1113378835'][21]()); $_63710695= null;  $_378124069= $GLOBALS['____1113378835'][22](function($_1187226907){ return[___893756838(34) => $_1187226907[___893756838(35)], ___893756838(36) => (int) $_1187226907[___893756838(37)]];}, ModuleManager::getModulesFromDisk());  $_1766713322=[]; foreach($GLOBALS['____1113378835'][23]() as $_548495179){ $_1174064096= new ReflectionExtension($_548495179); $_1766713322[$_548495179]=[ ___893756838(38) => $_1174064096->getVersion(), ___893756838(39) => $_1174064096->getINIEntries()];} $_1856091826=[ ___893756838(40) => $GLOBALS['____1113378835'][24]($_378124069), ___893756838(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___893756838(42) => $GLOBALS['____1113378835'][25]([ ___893756838(43) => $GLOBALS['____1113378835'][26](), ___893756838(44) => $_1766713322])]; if(Loader::includeModule(___893756838(45))){ $_1960305990= CSecuritySystemInformation::getSystemInformation(); if(isset($_1960305990[___893756838(46)][___893756838(47)]) && isset($_1960305990[___893756838(48)][___893756838(49)])){ $_1856091826[___893756838(50)]=[ ___893756838(51) => $_1960305990[___893756838(52)][___893756838(53)], ___893756838(54) => $_1960305990[___893756838(55)][___893756838(56)]];} if(isset($_1960305990[___893756838(57)][___893756838(58)])){ $_1856091826[___893756838(59)]=[___893756838(60) => $_1960305990[___893756838(61)][___893756838(62)]];}}  $_1398059120= new HttpClient([ ___893756838(63) => round(0+1.6666666666667+1.6666666666667+1.6666666666667), ___893756838(64) => round(0+1.6666666666667+1.6666666666667+1.6666666666667)]); $_2061115986= $_1398059120->post( static::$_1317852618, $_1856091826); if($_1398059120->getStatus() == round(0+50+50+50+50) &&!empty($_2061115986)){ $_63710695= Json::decode($_2061115986);}  if($_63710695 !== null){ $_1974467194= Application::getConnection(); $_1448923200= RuleRecordTable::getTableName(); if(!empty($_63710695)){ foreach($_63710695 as $_1422105149){ if(!static::checkRuleSign($_1422105149)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1113378835'][27]($_1422105149));}}}  $_1974467194->truncateTable($_1448923200);  if(!empty($_63710695)){ $_588588966=[]; foreach($_63710695 as $_1422105149){ $_588588966[]= ___893756838(65). $_1974467194->getSqlHelper()->forSql($_1422105149[___893756838(66)]). ___893756838(67). $_1974467194->getSqlHelper()->forSql($_1422105149[___893756838(68)]). ___893756838(69). $_1974467194->getSqlHelper()->forSql($_1422105149[___893756838(70)]). ___893756838(71);} $_170415034= $GLOBALS['____1113378835'][28](___893756838(72), $_588588966);  $_1974467194->query("INSERT INTO {$_1448923200} (DATA, MODULE, MODULE_VERSION) VALUES {$_170415034}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_985897926){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___893756838(73), ___893756838(74), ___893756838(75), ___893756838(76). $_985897926->getMessage(). ___893756838(77). $_985897926->getTraceAsString());}} protected static function checkRuleSign($_2042899483){ $_413363719= new PublicKeyCipher; $_719215836= $_413363719->decrypt($_2042899483[___893756838(78)], static::__2000683850()); return str_starts_with($_719215836, ___893756838(79));} private static function __2000683850(){ $_1536756108= ''; $_1536756108 .= ___893756838(80); $_1536756108 .= ___893756838(81); return $_1536756108;} protected function logEvent($_1449840687, $_1295573284, $_1935960096){ if($this->_1861785850){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1449840687, 'main', $_1295573284, $_1935960096);}}}?>